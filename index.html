<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti√≥n Profesional de Bicicletas con Inventario</title>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <style>
    /* ---------------------------------------------------------------------- */
    /* ESTILOS DE LA APLICACI√ìN (Mismos que el c√≥digo original) */
    /* ---------------------------------------------------------------------- */
    body {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100%;
        height: 100%;
      }
      
      html {
        height: 100%;
      }
      
      * {
        box-sizing: border-box;
      }
      
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }
      
      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }
      
      .header h1 {
        font-size: 42px;
        margin: 0 0 10px 0;
        font-weight: 800;
        letter-spacing: -0.5px;
        text-shadow: 0 2px 10px rgba(0,0,0,0.2);
      }
      
      .header p {
        font-size: 16px;
        opacity: 0.95;
        margin: 0;
        font-weight: 500;
      }
      
      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        background: rgba(255, 255, 255, 0.15);
        padding: 10px;
        border-radius: 16px;
        backdrop-filter: blur(10px);
        flex-wrap: wrap;
      }
      
      .tab {
        flex: 1;
        min-width: 150px;
        padding: 14px 20px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 12px;
        color: white;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      
      .tab:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
      }
      
      .tab.active {
        background: white;
        color: #667eea;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      
      .content {
        background: white;
        border-radius: 20px;
        padding: 35px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        min-height: 500px;
      }
      
      .view {
        display: none;
      }
      
      .view.active {
        display: block;
      }
      
      .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        flex-wrap: wrap;
        gap: 15px;
      }
      
      .add-button {
        background: #667eea;
        color: white;
        border: none;
        padding: 14px 28px;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }
      
      .add-button:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
      }
      
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      
      .stat-card {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 25px;
        border-radius: 16px;
        text-align: center;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        border: 2px solid transparent;
      }
      
      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        border-color: #667eea;
      }
      
      .stat-card-icon {
        font-size: 36px;
        margin-bottom: 10px;
        display: block;
      }
      
      .stat-value {
        font-size: 36px;
        font-weight: 800;
        color: #2d3748;
        margin-bottom: 8px;
        line-height: 1;
      }
      
      .stat-label {
        font-size: 13px;
        color: #718096;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .stat-sublabel {
        font-size: 11px;
        color: #a0aec0;
        margin-top: 5px;
        font-weight: 500;
      }
      
      .bike-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
        gap: 20px;
      }
      
      .bike-card {
        background: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
        border-radius: 16px;
        padding: 25px;
        transition: all 0.3s ease;
        position: relative;
        border: 3px solid #e2e8f0;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
      }
      
      .bike-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        border-color: #667eea;
      }
      
      .bike-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 15px;
      }
      
      .bike-icon {
        font-size: 56px;
        margin-bottom: 10px;
      }
      
      .bike-name {
        font-size: 22px;
        font-weight: 800;
        color: #2d3748;
        margin-bottom: 5px;
      }
      
      .bike-type {
        font-size: 14px;
        color: #718096;
        margin-bottom: 15px;
        font-weight: 600;
      }
      
      .bike-km-display {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 20px;
        border-radius: 12px;
        font-size: 18px;
        font-weight: 800;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }
      
      .bike-km-display .km-value {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .edit-km-btn {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }
      
      .edit-km-btn:hover {
        background: rgba(255,255,255,0.3);
        transform: scale(1.1);
      }
      
      .bike-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid #e2e8f0;
      }
      
      .bike-stat-item {
        text-align: center;
        padding: 10px;
        background: #f7fafc;
        border-radius: 8px;
      }
      
      .bike-stat-value {
        font-size: 20px;
        font-weight: 800;
        color: #2d3748;
      }
      
      .bike-stat-label {
        font-size: 11px;
        color: #718096;
        text-transform: uppercase;
        font-weight: 600;
        margin-top: 4px;
      }
      
      .alert-badge {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 12px;
        animation: pulse 2s infinite;
      }
      
      .alert-critical {
        background: #fee;
        color: #c53030;
        border: 2px solid #fc8181;
      }
      
      .alert-warning {
        background: #fffaf0;
        color: #c05621;
        border: 2px solid #fbd38d;
      }
      
      .alert-ok {
        background: #f0fff4;
        color: #2f855a;
        border: 2px solid #9ae6b4;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
      }
      
      .delete-bike {
        background: #e53e3e;
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-weight: 700;
      }
      
      .delete-bike:hover {
        background: #c53030;
        transform: scale(1.1);
      }
      
      .form-section {
        background: #f7fafc;
        padding: 30px;
        border-radius: 16px;
        margin-bottom: 25px;
      }
      
      .form-section h2 {
        margin: 0 0 25px 0;
        color: #2d3748;
        font-size: 24px;
        font-weight: 800;
      }
      
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
      }
      
      .form-group {
        margin-bottom: 0;
      }
      
      .form-group.full-width {
        grid-column: 1 / -1;
      }
      
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 700;
        color: #2d3748;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 15px;
        font-family: inherit;
        transition: all 0.3s ease;
        background: white;
      }
      
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      
      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }
      
      .form-actions {
        display: flex;
        gap: 15px;
        margin-top: 25px;
      }
      
      .btn-primary {
        flex: 1;
        background: #667eea;
        color: white;
        border: none;
        padding: 16px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .btn-primary:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
      }
      
      .btn-primary:disabled {
        background: #cbd5e0;
        cursor: not-allowed;
        transform: none;
      }
      
      .btn-secondary {
        flex: 1;
        background: #e2e8f0;
        color: #2d3748;
        border: none;
        padding: 16px;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .btn-secondary:hover {
        background: #cbd5e0;
      }
      
      .toolbar {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: center;
        background: #f7fafc;
        padding: 15px;
        border-radius: 12px;
      }
      
      .search-box {
        flex: 1;
        min-width: 250px;
        position: relative;
      }
      
      .search-box input {
        width: 100%;
        padding: 12px 16px 12px 40px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 14px;
        transition: all 0.3s ease;
      }
      
      .search-box input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      
      .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 18px;
        color: #a0aec0;
      }
      
      .filter-group {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      
      .filter-group label {
        font-size: 13px;
        font-weight: 700;
        color: #4a5568;
        white-space: nowrap;
      }
      
      .filter-group select {
        padding: 10px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        background: white;
        cursor: pointer;
        min-width: 150px;
      }
      
      .maintenance-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      
      .maintenance-item {
        background: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
        border-left: 5px solid #667eea;
        padding: 20px;
        border-radius: 12px;
        position: relative;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }
      
      .maintenance-item:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        transform: translateX(5px);
      }
      
      .maintenance-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 12px;
      }
      
      .maintenance-title {
        font-weight: 800;
        color: #2d3748;
        font-size: 18px;
        margin-bottom: 5px;
      }
      
      .maintenance-bike {
        font-size: 14px;
        color: #4a5568;
        font-weight: 600;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      
      .maintenance-meta {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin-top: 12px;
      }
      
      .meta-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: #718096;
        font-weight: 600;
        background: #f7fafc;
        padding: 6px 12px;
        border-radius: 8px;
      }
      
      .maintenance-component {
        display: inline-block;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 700;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      }
      
      .maintenance-cost {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 700;
        display: inline-block;
        margin-left: 8px;
        box-shadow: 0 2px 8px rgba(72, 187, 120, 0.3);
      }
      
      .maintenance-notes {
        font-size: 14px;
        color: #4a5568;
        margin-top: 12px;
        padding: 12px;
        background: white;
        border-radius: 8px;
        font-style: italic;
        border-left: 3px solid #cbd5e0;
        line-height: 1.6;
      }
      
      .delete-maintenance {
        background: #e53e3e;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 700;
        transition: all 0.3s ease;
      }
      
      .delete-maintenance:hover {
        background: #c53030;
        transform: scale(1.05);
      }
      
      .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: #718096;
      }
      
      .empty-state-icon {
        font-size: 80px;
        margin-bottom: 20px;
        opacity: 0.5;
      }
      
      .empty-state h3 {
        font-size: 24px;
        margin-bottom: 10px;
        color: #2d3748;
        font-weight: 800;
      }
      
      .empty-state p {
        font-size: 15px;
        font-weight: 500;
      }
      
      .component-history {
        background: white;
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 20px;
        border: 2px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      }
      
      .component-history h3 {
        margin: 0 0 20px 0;
        color: #2d3748;
        font-size: 20px;
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .component-list {
        display: grid;
        gap: 12px;
      }
      
      .component-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: #f7fafc;
        border-radius: 10px;
        border-left: 4px solid #667eea;
        transition: all 0.3s ease;
      }
      
      .component-item:hover {
        background: #edf2f7;
        transform: translateX(5px);
      }
      
      .component-name {
        font-weight: 700;
        color: #2d3748;
        font-size: 15px;
      }
      
      .component-info {
        display: flex;
        gap: 15px;
        align-items: center;
        font-size: 13px;
        color: #718096;
        font-weight: 600;
      }
      
      .km-badge {
        background: #667eea;
        color: white;
        padding: 6px 12px;
        border-radius: 12px;
        font-weight: 700;
      }
      
      .info-box {
        background: #edf2f7;
        border-left: 4px solid #4299e1;
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      
      .info-box p {
        margin: 0;
        color: #2d3748;
        font-size: 14px;
        font-weight: 600;
        line-height: 1.6;
      }
      
      .toast {
        position: fixed;
        bottom: 30px;
        right: 30px;
        background: #2d3748;
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        animation: slideIn 0.3s ease;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.3s ease;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 16px;
        max-width: 500px;
        width: 90%;
        animation: scaleIn 0.3s ease;
      }
      
      @keyframes scaleIn {
        from {
          transform: scale(0.9);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
      
      .top-components {
        background: white;
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 20px;
        border: 2px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      }
      
      .top-components h3 {
        margin: 0 0 20px 0;
        color: #2d3748;
        font-size: 20px;
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .top-component-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 12px;
        background: #f7fafc;
        border-radius: 10px;
        margin-bottom: 10px;
      }
      
      .rank-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 16px;
      }
      
      .rank-badge.gold {
        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        color: #2d3748;
      }
      
      .rank-badge.silver {
        background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
        color: #2d3748;
      }
      
      .rank-badge.bronze {
        background: linear-gradient(135deg, #cd7f32 0%, #e8a87c 100%);
        color: white;
      }
      
      .component-bar {
        flex: 1;
        height: 8px;
        background: #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
      }
      
      .component-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        border-radius: 4px;
        transition: width 0.5s ease;
      }
      
      .stock-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
      }
      
      .stock-card {
        background: linear-gradient(135deg, #ffffff 0%, #f7fafc 100%);
        border-radius: 16px;
        padding: 25px;
        transition: all 0.3s ease;
        position: relative;
        border: 3px solid #e2e8f0;
        box-shadow: 0 4px 6px rgba(0,0,0,0.07);
      }
      
      .stock-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        border-color: #667eea;
      }
      
      .stock-card.low-stock {
        border-color: #f6ad55;
        background: linear-gradient(135deg, #fffaf0 0%, #fef5e7 100%);
      }
      
      .stock-card.out-of-stock {
        border-color: #fc8181;
        background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
      }
      
      .stock-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 15px;
      }
      
      .stock-icon {
        font-size: 48px;
        margin-bottom: 10px;
      }
      
      .stock-name {
        font-size: 20px;
        font-weight: 800;
        color: #2d3748;
        margin-bottom: 5px;
      }
      
      .stock-category {
        display: inline-block;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 6px 14px;
        border-radius: 16px;
        font-size: 12px;
        font-weight: 700;
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .stock-brand {
        font-size: 14px;
        color: #718096;
        font-weight: 600;
        margin-bottom: 15px;
      }
      
      .stock-quantity-display {
        background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 800;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
        box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
      }
      
      .stock-quantity-display.low {
        background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
      }
      
      .stock-quantity-display.out {
        background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
      }
      
      .quantity-controls {
        display: flex;
        gap: 8px;
      }
      
      .quantity-btn {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 18px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }
      
      .quantity-btn:hover {
        background: rgba(255,255,255,0.3);
        transform: scale(1.1);
      }
      
      .stock-details {
        display: grid;
        gap: 10px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid #e2e8f0;
      }
      
      .stock-detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
      }
      
      .stock-detail-label {
        color: #718096;
        font-weight: 600;
      }
      
      .stock-detail-value {
        color: #2d3748;
        font-weight: 800;
      }
      
      .stock-notes-display {
        font-size: 13px;
        color: #4a5568;
        margin-top: 12px;
        padding: 10px;
        background: white;
        border-radius: 8px;
        font-style: italic;
        border-left: 3px solid #cbd5e0;
        line-height: 1.5;
      }
      
      .delete-stock {
        background: #e53e3e;
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-weight: 700;
      }
      
      .delete-stock:hover {
        background: #c53030;
        transform: scale(1.1);
      }
      
      .stock-alert {
        padding: 8px 14px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 10px;
      }
      
      .stock-alert.warning {
        background: #fffaf0;
        color: #c05621;
        border: 2px solid #fbd38d;
      }
      
      .stock-alert.danger {
        background: #fee;
        color: #c53030;
        border: 2px solid #fc8181;
      }

    /* ---------------------------------------------------------------------- */
    /* ESTILOS DE AUTENTICACI√ìN (LOGIN) */
    /* ---------------------------------------------------------------------- */
    #login-view {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .auth-card {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .auth-card h2 {
      font-size: 28px;
      margin-bottom: 25px;
      color: #2d3748;
    }

    .auth-card input {
      width: 100%;
      padding: 12px 15px;
      margin-bottom: 15px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 16px;
    }

    .auth-card button {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-auth-primary {
      background: #667eea;
      color: white;
      margin-bottom: 10px;
    }

    .btn-auth-secondary {
      background: #e2e8f0;
      color: #2d3748;
    }

    .btn-auth-primary:hover {
      background: #5568d3;
    }

    .btn-auth-secondary:hover {
      background: #cbd5e0;
    }

    .error-message {
      color: #e53e3e;
      font-weight: 600;
      margin-bottom: 15px;
    }

    .logout-button {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.3);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s;
        z-index: 50;
    }

    .logout-button:hover {
        background: rgba(255, 255, 255, 0.5);
    }
  </style>

  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>

  <div id="login-view" style="display: none;">
    <div class="auth-card">
      <h2>Iniciar Sesi√≥n üö¥</h2>
      <div id="auth-error" class="error-message" style="display: none;"></div>
      <input type="email" id="auth-email" placeholder="Correo Electr√≥nico" required>
      <input type="password" id="auth-password" placeholder="Contrase√±a" required>
      <button class="btn-auth-primary" onclick="handleLogin('login')">INICIAR SESI√ìN</button>
      <button class="btn-auth-secondary" onclick="handleLogin('register')">REGISTRARSE</button>
      <p style="margin-top: 20px; font-size: 12px; color: #718096;">La aplicaci√≥n es gratuita.</p>
    </div>
  </div>
  
  <div id="app-view" class="container" style="display: none;">
    <button class="logout-button" onclick="handleLogout()">üö™ Cerrar Sesi√≥n</button>
    <header class="header">
      <h1 id="app-title">üö¥ Mis Bicicletas</h1>
      <p>Sistema profesional de gesti√≥n, mantenimiento e inventario</p>
    </header>
    <nav class="tabs">
      <button class="tab active" onclick="switchTab('bikes')"> <span>üö¥</span> Mis Bicicletas </button>
      <button class="tab" onclick="switchTab('maintenance')"> <span>üîß</span> Mantenimientos </button>
      <button class="tab" onclick="switchTab('stock')"> <span>üì¶</span> Inventario </button>
      <button class="tab" onclick="switchTab('stats')"> <span>üìä</span> Estad√≠sticas </button>
    </nav>
    <main class="content">
      <div id="bikes-view" class="view active">
        <div class="action-bar"><button class="add-button" id="add-bike-btn" onclick="showAddBikeForm()"> <span>+</span> Nueva Bicicleta </button>
        </div>
        <div id="bike-form" style="display: none;">
          <div class="form-section">
            <h2>Registrar Nueva Bicicleta</h2>
            <form id="new-bike-form" onsubmit="handleAddBike(event)">
              <div class="form-grid">
                <div class="form-group"><label for="bike-name">Nombre de la Bicicleta *</label> <input type="text" id="bike-name" required placeholder="Ej: Mi MTB Roja">
                </div>
                <div class="form-group"><label for="bike-type">Tipo de Bicicleta *</label> <select id="bike-type" required> <option value="">Selecciona un tipo</option> <option value="Monta√±a">üèîÔ∏è Monta√±a (MTB)</option> <option value="Carretera">üèÅ Carretera</option> <option value="Urbana">üèôÔ∏è Urbana</option> <option value="El√©ctrica">‚ö° El√©ctrica</option> <option value="BMX">üé™ BMX</option> <option value="Gravel">üåæ Gravel</option> <option value="H√≠brida">üîÄ H√≠brida</option> </select>
                </div>
                <div class="form-group"><label for="bike-color">Color *</label> <input type="text" id="bike-color" required placeholder="Ej: Rojo">
                </div>
                <div class="form-group"><label for="bike-km">Kilometraje Actual *</label> <input type="number" id="bike-km" required placeholder="0" min="0" step="0.1">
                </div>
              </div>
              <div class="form-actions"><button type="submit" class="btn-primary" id="save-bike-btn">Guardar Bicicleta</button> <button type="button" class="btn-secondary" onclick="hideAddBikeForm()">Cancelar</button>
              </div>
            </form>
          </div>
        </div>
        <div id="bikes-list" class="bike-grid"></div>
      </div>
      <div id="maintenance-view" class="view">
        <div class="action-bar"><button class="add-button" id="add-maintenance-btn" onclick="showAddMaintenanceForm()"> <span>+</span> Nuevo Mantenimiento </button>
        </div>
        <div id="maintenance-form" style="display: none;">
          <div class="form-section">
            <h2>Registrar Mantenimiento</h2>
            <div class="info-box">
              <p>üí° <strong>Consejo:</strong> Registra el kilometraje actual para hacer seguimiento del desgaste de componentes y recibir alertas de mantenimiento preventivo.</p>
            </div>
            <form id="new-maintenance-form" onsubmit="handleAddMaintenance(event)">
              <div class="form-grid">
                <div class="form-group"><label for="maintenance-bike">Bicicleta *</label> <select id="maintenance-bike" required> <option value="">Selecciona una bicicleta</option> </select>
                </div>
                <div class="form-group"><label for="maintenance-type">Tipo de Mantenimiento *</label> <select id="maintenance-type" required> <option value="">Selecciona un tipo</option> <option value="Cambio de componente">üîÑ Cambio de componente</option> <option value="Reparaci√≥n">üî® Reparaci√≥n</option> <option value="Limpieza">üßº Limpieza</option> <option value="Ajuste">‚öôÔ∏è Ajuste</option> <option value="Revisi√≥n general">‚úÖ Revisi√≥n general</option> <option value="Lubricaci√≥n">üíß Lubricaci√≥n</option> </select>
                </div>
                <div class="form-group"><label for="maintenance-component">Componente *</label> <select id="maintenance-component" required> <option value="">Selecciona un componente</option> <optgroup label="Transmisi√≥n"> <option value="Cadena">‚õìÔ∏è Cadena</option> <option value="Cassette">‚öôÔ∏è Cassette</option> <option value="Platos">üîò Platos</option> <option value="Bielas">üîß Bielas</option> <option value="Cambio">üîÑ Cambio</option> <option value="Desviador">‚ÜîÔ∏è Desviador</option> <option value="Cables">üìè Cables</option> <option value="Fundas">üîå Fundas</option> </optgroup> <optgroup label="Ruedas y Neum√°ticos"> <option value="Cubierta delantera">üõû Cubierta delantera</option> <option value="Cubierta trasera">üõû Cubierta trasera</option> <option value="C√°mara delantera">‚≠ï C√°mara delantera</option> <option value="C√°mara trasera">‚≠ï C√°mara trasera</option> <option value="Llanta delantera">‚ö™ Llanta delantera</option> <option value="Llanta trasera">‚ö™ Llanta trasera</option> <option value="Radios">üìç Radios</option> </optgroup> <optgroup label="Frenos"> <option value="Frenos">üõë Frenos</option> <option value="Pastillas de freno">üî≤ Pastillas de freno</option> <option value="Discos de freno">üíø Discos de freno</option> <option value="L√≠quido de frenos">üíß L√≠quido de frenos</option> </optgroup> <optgroup label="Suspensi√≥n"> <option value="Horquilla">üç¥ Horquilla</option> <option value="Amortiguador">üî© Amortiguador</option> </optgroup> <optgroup label="Cockpit"> <option value="Manillar">üéØ Manillar</option> <option value="Potencia">üìê Potencia</option> <option value="Pu√±os">‚úä Pu√±os</option> <option value="Cinta manillar">üéÄ Cinta manillar</option> </optgroup> <optgroup label="Sill√≠n"> <option value="Sill√≠n">ü™ë Sill√≠n</option> <option value="Tija">üìè Tija</option> </optgroup> <optgroup label="Otros"> <option value="Pedales">üëü Pedales</option> <option value="Pedalier">‚öôÔ∏è Pedalier</option> <option value="Direcci√≥n">üß≠ Direcci√≥n</option> <option value="Otro">‚ùì Otro</option> </optgroup> </select>
                </div>
                <div class="form-group"><label for="maintenance-date">Fecha *</label> <input type="date" id="maintenance-date" required>
                </div>
                <div class="form-group"><label for="maintenance-km">Kilometraje en el Mantenimiento</label> <input type="number" id="maintenance-km" placeholder="Km actuales" min="0" step="0.1">
                </div>
                <div class="form-group"><label for="maintenance-cost">Coste (<span id="currency-display">‚Ç¨</span>)</label> <input type="number" id="maintenance-cost" placeholder="0.00" min="0" step="0.01">
                </div>
                <div class="form-group"><label for="next-maintenance-km">Pr√≥ximo Mantenimiento (Km)</label> <input type="number" id="next-maintenance-km" placeholder="Ej: 500 km despu√©s" min="0" step="1">
                </div>
                <div class="form-group full-width"><label for="maintenance-notes">Notas y Observaciones</label> <textarea id="maintenance-notes" placeholder="A√±ade detalles sobre el mantenimiento, marca del componente, problemas encontrados, etc."></textarea>
                </div>
              </div>
              <div class="form-actions"><button type="submit" class="btn-primary" id="save-maintenance-btn">Guardar Mantenimiento</button> <button type="button" class="btn-secondary" onclick="hideAddMaintenanceForm()">Cancelar</button>
              </div>
            </form>
          </div>
        </div>
        <div class="toolbar">
          <div class="search-box"><span class="search-icon">üîç</span> <input type="text" id="search-maintenance" placeholder="Buscar mantenimientos..." oninput="filterMaintenance()">
          </div>
          <div class="filter-group"><label for="filter-bike">Bicicleta:</label> <select id="filter-bike" onchange="filterMaintenance()"> <option value="">Todas</option> </select>
          </div>
          <div class="filter-group"><label for="filter-component">Componente:</label> <select id="filter-component" onchange="filterMaintenance()"> <option value="">Todos</option> </select>
          </div>
          <div class="filter-group"><label for="sort-maintenance">Ordenar:</label> <select id="sort-maintenance" onchange="filterMaintenance()"> <option value="date-desc">Fecha (m√°s reciente)</option> <option value="date-asc">Fecha (m√°s antiguo)</option> <option value="cost-desc">Coste (mayor)</option> <option value="cost-asc">Coste (menor)</option> <option value="km-desc">Kilometraje (mayor)</option> <option value="km-asc">Kilometraje (menor)</option> </select>
          </div>
        </div>
        <div id="maintenance-list" class="maintenance-list"></div>
      </div>
      <div id="stock-view" class="view">
        <div class="action-bar"><button class="add-button" onclick="showAddStockForm()"> <span>+</span> A√±adir Material </button>
        </div>
        <div id="stock-form" style="display: none;">
          <div class="form-section">
            <h2>A√±adir Material al Inventario</h2>
            <div class="info-box">
              <p>üì¶ <strong>Gestiona tu stock:</strong> Mant√©n un control de tus componentes y materiales. Recibir√°s alertas cuando el stock est√© bajo.</p>
            </div>
            <form id="new-stock-form" onsubmit="handleAddStock(event)">
              <div class="form-grid">
                <div class="form-group"><label for="stock-name">Nombre del Material *</label> <input type="text" id="stock-name" required placeholder="Ej: Cadena KMC X11">
                </div>
                <div class="form-group"><label for="stock-category">Categor√≠a *</label> <select id="stock-category" required> <option value="">Selecciona una categor√≠a</option> <option value="Transmisi√≥n">‚õìÔ∏è Transmisi√≥n</option> <option value="Frenos">üõë Frenos</option> <option value="Ruedas">üõû Ruedas</option> <option value="Suspensi√≥n">üî© Suspensi√≥n</option> <option value="Cockpit">üéØ Cockpit</option> <option value="Sill√≠n">ü™ë Sill√≠n</option> <option value="Lubricantes">üíß Lubricantes</option> <option value="Herramientas">üîß Herramientas</option> <option value="Accesorios">‚ú® Accesorios</option> <option value="Otros">üì¶ Otros</option> </select>
                </div>
                <div class="form-group"><label for="stock-brand">Marca</label> <input type="text" id="stock-brand" placeholder="Ej: Shimano, SRAM, etc.">
                </div>
                <div class="form-group"><label for="stock-quantity">Cantidad Actual *</label> <input type="number" id="stock-quantity" required placeholder="0" min="0" step="1">
                </div>
                <div class="form-group"><label for="stock-min-quantity">Stock M√≠nimo *</label> <input type="number" id="stock-min-quantity" required placeholder="1" min="0" step="1">
                </div>
                <div class="form-group"><label for="stock-unit-price">Precio Unitario (<span id="currency-display-stock">‚Ç¨</span>)</label> <input type="number" id="stock-unit-price" placeholder="0.00" min="0" step="0.01">
                </div>
                <div class="form-group"><label for="stock-location">Ubicaci√≥n</label> <input type="text" id="stock-location" placeholder="Ej: Estante A, Caj√≥n 3">
                </div>
                <div class="form-group full-width"><label for="stock-notes">Notas</label> <textarea id="stock-notes" placeholder="Informaci√≥n adicional sobre el material..."></textarea>
                </div>
              </div>
              <div class="form-actions"><button type="submit" class="btn-primary" id="save-stock-btn">Guardar Material</button> <button type="button" class="btn-secondary" onclick="hideAddStockForm()">Cancelar</button>
              </div>
            </form>
          </div>
        </div>
        <div class="toolbar">
          <div class="search-box"><span class="search-icon">üîç</span> <input type="text" id="search-stock" placeholder="Buscar materiales..." oninput="filterStock()">
          </div>
          <div class="filter-group"><label for="filter-stock-category">Categor√≠a:</label> <select id="filter-stock-category" onchange="filterStock()"> <option value="">Todas</option> </select>
          </div>
          <div class="filter-group"><label for="filter-stock-status">Estado:</label> <select id="filter-stock-status" onchange="filterStock()"> <option value="">Todos</option> <option value="ok">‚úÖ Stock OK</option> <option value="low">‚ö†Ô∏è Stock Bajo</option> <option value="out">üö® Sin Stock</option> </select>
          </div>
        </div>
        <div id="stock-list" class="stock-grid"></div>
      </div>
      <div id="stats-view" class="view">
        <h2 style="margin-bottom: 25px; color: #2d3748; font-size: 28px; font-weight: 800;">üìä Estad√≠sticas Generales</h2>
        <div class="stats-grid" id="general-stats"></div>
        <div id="top-components-section"></div>
        <div id="bike-details-section"></div>
      </div>
    </main>
  </div>
  
  <script>
    // --- 2. FIREBASE CONFIGURACI√ìN E INICIALIZACI√ìN (¬°TUS DATOS!) ---
    const firebaseConfig = {
      apiKey: "AIzaSyA3D7fH6QpdG7mUSNhFfUzD6RWje8TpGEk",
      authDomain: "hostaldatossincro.firebaseapp.com",
      databaseURL: "https://hostaldatossincro-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hostaldatossincro",
      storageBucket: "hostaldatossincro.firebasestorage.app",
      messagingSenderId: "955112940193",
      appId: "1:955112940193:web:f30f52858c1e6c0ddc46e0"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // VARIABLES GLOBALES
    let allData = [];
    let userId = null;
    let dbRef = null; // Referencia a la colecci√≥n espec√≠fica del usuario
    let unsubscribeFirestore = null; 

    // --- FUNCIONES DE AUTENTICACI√ìN ---

    function displayAuthError(message) {
      const errorEl = document.getElementById('auth-error');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 5000);
    }

    async function handleLogin(action) {
      const email = document.getElementById('auth-email').value;
      const password = document.getElementById('auth-password').value;
      const errorEl = document.getElementById('auth-error');
      errorEl.style.display = 'none';

      if (!email || !password) {
        displayAuthError("Por favor, introduce correo y contrase√±a.");
        return;
      }

      try {
        if (action === 'login') {
          await auth.signInWithEmailAndPassword(email, password);
          showToast("‚úÖ Sesi√≥n iniciada correctamente");
        } else if (action === 'register') {
          await auth.createUserWithEmailAndPassword(email, password);
          showToast("‚úÖ Registro exitoso. ¬°Bienvenido!");
        }
      } catch (error) {
        let errorMessage = "Ocurri√≥ un error de autenticaci√≥n.";
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
          errorMessage = "Correo o contrase√±a inv√°lidos.";
        } else if (error.code === 'auth/email-already-in-use') {
          errorMessage = "El correo ya est√° en uso. Intenta iniciar sesi√≥n.";
        } else if (error.code === 'auth/weak-password') {
          errorMessage = "La contrase√±a debe tener al menos 6 caracteres.";
        }
        displayAuthError(errorMessage);
      }
    }

    async function handleLogout() {
      try {
        await auth.signOut();
        showToast("üö™ Sesi√≥n cerrada.");
      } catch (error) {
        showToast("‚ùå Error al cerrar sesi√≥n.");
      }
    }

    // Listener de estado de autenticaci√≥n (Carga la app o muestra el login)
    auth.onAuthStateChanged(user => {
      if (user) {
        // Usuario logueado: Ocultar Login, Mostrar App
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('app-view').style.display = 'block';
        userId = user.uid;
        // La referencia a la base de datos es espec√≠fica para el usuario
        // Colecci√≥n: users -> [UID] -> appData
        dbRef = db.collection('users').doc(userId).collection('appData');
        listenToDataChanges(); // Iniciar la sincronizaci√≥n
      } else {
        // Usuario deslogueado: Mostrar Login, Ocultar App
        document.getElementById('login-view').style.display = 'flex';
        document.getElementById('app-view').style.display = 'none';
        userId = null;
        allData = []; // Limpiar datos locales
        if (unsubscribeFirestore) {
          unsubscribeFirestore(); // Detener la sincronizaci√≥n
          unsubscribeFirestore = null;
        }
        // Limpiar vistas
        document.getElementById('bikes-list').innerHTML = '';
        document.getElementById('maintenance-list').innerHTML = '';
        document.getElementById('stock-list').innerHTML = '';
        document.getElementById('general-stats').innerHTML = '';
      }
    });

    // --- FUNCIONES DE FIREBASE FIRESTORE PARA SINCRONIZACI√ìN ---

    function listenToDataChanges() {
      if (unsubscribeFirestore) {
        unsubscribeFirestore(); // Detener la escucha anterior
      }
      
      // Sincronizaci√≥n en tiempo real
      unsubscribeFirestore = dbRef.onSnapshot(snapshot => {
        const changes = snapshot.docChanges();
        let shouldRender = false;
        
        changes.forEach(change => {
          const data = { id: change.doc.id, ...change.doc.data() };
          
          if (change.type === 'added') {
            allData.push(data);
            shouldRender = true;
          } else if (change.type === 'modified') {
            const index = allData.findIndex(d => d.id === data.id);
            if (index !== -1) {
              allData[index] = data;
              shouldRender = true;
            }
          } else if (change.type === 'removed') {
            allData = allData.filter(d => d.id !== data.id);
            shouldRender = true;
          }
        });

        if (shouldRender) {
          onDataChanged(allData); 
        }
      }, err => {
        console.error("Error al escuchar Firestore:", err);
        showToast("‚ùå Error al sincronizar datos. Intenta recargar.");
      });
    }

    // Manejador de cambios (antiguo dataHandler)
    function onDataChanged(data) {
      allData = data;
      renderBikes();
      renderMaintenance();
      renderStock();
      renderStats();
      updateBikeSelectors();
      updateComponentFilter();
      updateStockCategoryFilter();
    }
    
    // Funciones CRUD usando Firestore

    async function createData(data) {
      try {
        const docRef = dbRef.doc(); 
        const newData = { ...data, id: docRef.id };
        await docRef.set(newData);
        return { isOk: true };
      } catch (error) {
        console.error("Error creando dato:", error);
        return { isOk: false, error };
      }
    }

    async function updateData(data) {
      try {
        await dbRef.doc(data.id).update(data);
        return { isOk: true };
      } catch (error) {
        console.error("Error actualizando dato:", error);
        return { isOk: false, error };
      }
    }

    async function deleteData(data) {
      try {
        await dbRef.doc(data.id).delete();
        return { isOk: true };
      } catch (error) {
        console.error("Error eliminando dato:", error);
        return { isOk: false, error };
      }
    }


    // --- HANDLERS DE FORMULARIO ACTUALIZADOS ---

    async function handleAddBike(event) {
      event.preventDefault();
      
      const saveBtn = document.getElementById('save-bike-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Guardando...';

      const bikeData = {
        type: 'bike',
        bike_name: document.getElementById('bike-name').value,
        bike_type: document.getElementById('bike-type').value,
        bike_color: document.getElementById('bike-color').value,
        total_km: parseFloat(document.getElementById('bike-km').value) || 0,
        created_at: new Date().toISOString()
      };

      const result = await createData(bikeData);
      
      saveBtn.disabled = false;
      saveBtn.textContent = 'Guardar Bicicleta';

      if (result.isOk) {
        hideAddBikeForm();
        showToast("‚úÖ Bicicleta registrada correctamente");
      } else {
        showToast("‚ùå Error al guardar la bicicleta");
      }
    }

    async function handleAddMaintenance(event) {
      event.preventDefault();
      
      const saveBtn = document.getElementById('save-maintenance-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Guardando...';

      const bikeId = document.getElementById('maintenance-bike').value;
      const bike = allData.find(d => d.id === bikeId);
      if (!bike) {
          showToast("‚ö†Ô∏è Bicicleta no encontrada.");
          saveBtn.disabled = false;
          saveBtn.textContent = 'Guardar Mantenimiento';
          return;
      }
      const kmAtMaintenance = parseFloat(document.getElementById('maintenance-km').value) || null;
      const nextMaintenanceKm = parseFloat(document.getElementById('next-maintenance-km').value) || null;

      const maintenanceData = {
        type: 'maintenance',
        bike_id: bikeId,
        bike_name: bike.bike_name,
        maintenance_type: document.getElementById('maintenance-type').value,
        component: document.getElementById('maintenance-component').value,
        date: document.getElementById('maintenance-date').value,
        km_at_maintenance: kmAtMaintenance,
        cost: parseFloat(document.getElementById('maintenance-cost').value) || 0,
        notes: document.getElementById('maintenance-notes').value,
        next_maintenance_km: nextMaintenanceKm,
        created_at: new Date().toISOString()
      };

      const result = await createData(maintenanceData);
      
      saveBtn.disabled = false;
      saveBtn.textContent = 'Guardar Mantenimiento';

      if (result.isOk) {
        hideAddMaintenanceForm();
        showToast("‚úÖ Mantenimiento registrado correctamente");
      } else {
        showToast("‚ùå Error al guardar el mantenimiento");
      }
    }

    async function handleAddStock(event) {
      event.preventDefault();
      
      const saveBtn = document.getElementById('save-stock-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Guardando...';

      const stockData = {
        type: 'stock',
        stock_name: document.getElementById('stock-name').value,
        stock_category: document.getElementById('stock-category').value,
        stock_brand: document.getElementById('stock-brand').value || '',
        stock_quantity: parseInt(document.getElementById('stock-quantity').value) || 0,
        stock_min_quantity: parseInt(document.getElementById('stock-min-quantity').value) || 1,
        stock_unit_price: parseFloat(document.getElementById('stock-unit-price').value) || 0,
        stock_location: document.getElementById('stock-location').value || '',
        stock_notes: document.getElementById('stock-notes').value || '',
        created_at: new Date().toISOString()
      };

      const result = await createData(stockData);
      
      saveBtn.disabled = false;
      saveBtn.textContent = 'Guardar Material';

      if (result.isOk) {
        hideAddStockForm();
        showToast("‚úÖ Material a√±adido al inventario");
      } else {
        showToast("‚ùå Error al guardar el material");
      }
    }

    async function deleteBike(bikeId) {
      const bike = allData.find(d => d.id === bikeId);
      if (!bike) return;

      const deleteBtn = event.target;
      deleteBtn.disabled = true;
      deleteBtn.textContent = '...';

      const result = await deleteData(bike);

      if (!result.isOk) {
        deleteBtn.disabled = false;
        deleteBtn.textContent = '√ó';
        showToast("‚ùå Error al eliminar la bicicleta");
      } else {
        showToast("‚úÖ Bicicleta eliminada");
      }
    }

    async function deleteMaintenance(maintenanceId) {
      const maintenance = allData.find(d => d.id === maintenanceId);
      if (!maintenance) return;

      const deleteBtn = event.target;
      deleteBtn.disabled = true;
      deleteBtn.textContent = 'Eliminando...';

      const result = await deleteData(maintenance);

      if (!result.isOk) {
        deleteBtn.disabled = false;
        deleteBtn.textContent = 'Eliminar';
        showToast("‚ùå Error al eliminar el mantenimiento");
      } else {
        showToast("‚úÖ Mantenimiento eliminado");
      }
    }

    async function deleteStock(stockId) {
      const stock = allData.find(d => d.id === stockId);
      if (!stock) return;

      const deleteBtn = event.target;
      deleteBtn.disabled = true;
      deleteBtn.textContent = '...';

      const result = await deleteData(stock);

      if (!result.isOk) {
        deleteBtn.disabled = false;
        deleteBtn.textContent = '√ó';
        showToast("‚ùå Error al eliminar el material");
      } else {
        showToast("‚úÖ Material eliminado del inventario");
      }
    }

    async function updateStockQuantity(stockId, change) {
      const stock = allData.find(d => d.id === stockId);
      if (!stock) return;

      const newQuantity = Math.max(0, stock.stock_quantity + change);
      const updatedStock = { ...stock, stock_quantity: newQuantity };

      const result = await updateData(updatedStock);

      if (!result.isOk) {
        showToast("‚ùå Error al actualizar la cantidad");
      }
    }

    async function updateBikeKm(bikeId) {
      const bike = allData.find(d => d.id === bikeId);
      if (!bike) return;

      const newKm = parseFloat(document.getElementById('new-km').value);
      
      if (newKm < bike.total_km) {
        showToast("‚ö†Ô∏è El nuevo kilometraje no puede ser menor al actual");
        return;
      }

      const updatedBike = { ...bike, total_km: newKm };
      const result = await updateData(updatedBike);

      if (result.isOk) {
        closeModal();
        showToast("‚úÖ Kilometraje actualizado correctamente");
      } else {
        showToast("‚ùå Error al actualizar el kilometraje");
      }
    }

    // --- FUNCIONES DE UI Y RENDERIZADO (NO MODIFICADAS) ---

    const defaultConfig = {
      app_title: "üö¥ Mis Bicicletas",
      add_bike_button: "Nueva Bicicleta",
      add_maintenance_button: "Nuevo Mantenimiento",
      currency_symbol: "‚Ç¨",
      background_color: "#667eea",
      surface_color: "#ffffff",
      text_color: "#2d3748",
      primary_action_color: "#667eea",
      secondary_action_color: "#e53e3e"
    };

    function init() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('maintenance-date').value = today;
    }
    
    function switchTab(tab) {
      const tabs = document.querySelectorAll('.tab');
      const views = document.querySelectorAll('.view');
      
      tabs.forEach(t => t.classList.remove('active'));
      views.forEach(v => v.classList.remove('active'));
      
      event.target.closest('.tab').classList.add('active');
      document.getElementById(`${tab}-view`).classList.add('active');
      
      if (tab === 'stats') {
        renderStats();
      } else if (tab === 'stock') {
        renderStock();
      }
    }

    function showAddBikeForm() {
      document.getElementById('bike-form').style.display = 'block';
      document.getElementById('bikes-list').style.display = 'none';
    }

    function hideAddBikeForm() {
      document.getElementById('bike-form').style.display = 'none';
      document.getElementById('bikes-list').style.display = 'grid';
      document.getElementById('new-bike-form').reset();
    }

    function showAddMaintenanceForm() {
      document.getElementById('maintenance-form').style.display = 'block';
      document.getElementById('maintenance-list').style.display = 'none';
      document.querySelector('.toolbar').style.display = 'none';
    }

    function hideAddMaintenanceForm() {
      document.getElementById('maintenance-form').style.display = 'none';
      document.getElementById('maintenance-list').style.display = 'flex';
      document.querySelector('.toolbar').style.display = 'flex';
      document.getElementById('new-maintenance-form').reset();
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('maintenance-date').value = today;
    }

    function showAddStockForm() {
      document.getElementById('stock-form').style.display = 'block';
      document.getElementById('stock-list').style.display = 'none';
      document.querySelectorAll('.toolbar')[1].style.display = 'none';
    }

    function hideAddStockForm() {
      document.getElementById('stock-form').style.display = 'none';
      document.getElementById('stock-list').style.display = 'grid';
      document.querySelectorAll('.toolbar')[1].style.display = 'flex';
      document.getElementById('new-stock-form').reset();
    }

    function renderBikes() {
      const bikesList = document.getElementById('bikes-list');
      const bikes = allData.filter(d => d.type === 'bike');

      if (bikes.length === 0) {
        bikesList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üö¥</div>
            <h3>No hay bicicletas registradas</h3>
            <p>A√±ade tu primera bicicleta para empezar a gestionar su mantenimiento profesionalmente</p>
          </div>
        `;
        return;
      }

      bikesList.innerHTML = bikes.map(bike => {
        const maintenance = allData.filter(d => d.type === 'maintenance' && d.bike_id === bike.id);
        const maintenanceCount = maintenance.length;
        const totalCost = maintenance.reduce((sum, m) => sum + (m.cost || 0), 0);
        
        const currencySymbol = defaultConfig.currency_symbol; 

        const upcomingMaintenances = maintenance
          .filter(m => m.next_maintenance_km && m.km_at_maintenance)
          .map(m => ({
            component: m.component,
            targetKm: m.km_at_maintenance + m.next_maintenance_km,
            kmLeft: (m.km_at_maintenance + m.next_maintenance_km) - bike.total_km
          }))
          .filter(m => m.kmLeft > 0)
          .sort((a, b) => a.kmLeft - b.kmLeft);

        const nextMaintenance = upcomingMaintenances[0];
        
        let alertClass = '';
        let alertIcon = '';
        let alertText = '';
        
        if (nextMaintenance) {
          if (nextMaintenance.kmLeft < 50) {
            alertClass = 'alert-critical';
            alertIcon = 'üö®';
            alertText = `URGENTE: ${nextMaintenance.component} (${nextMaintenance.kmLeft.toFixed(0)} km)`;
          } else if (nextMaintenance.kmLeft < 150) {
            alertClass = 'alert-warning';
            alertIcon = '‚ö†Ô∏è';
            alertText = `Pr√≥ximo: ${nextMaintenance.component} (${nextMaintenance.kmLeft.toFixed(0)} km)`;
          } else {
            alertClass = 'alert-ok';
            alertIcon = '‚úÖ';
            alertText = `Todo OK - Pr√≥ximo: ${nextMaintenance.component} (${nextMaintenance.kmLeft.toFixed(0)} km)`;
          }
        }

        return `
          <div class="bike-card">
            <div class="bike-header">
              <div>
                <div class="bike-icon">üö¥</div>
                <div class="bike-name">${bike.bike_name}</div>
                <div class="bike-type">${bike.bike_type} ‚Ä¢ ${bike.bike_color}</div>
              </div>
              <button class="delete-bike" onclick="deleteBike('${bike.id}')" title="Eliminar bicicleta">√ó</button>
            </div>
            <div class="bike-km-display">
              <div class="km-value">
                <span>üìç</span>
                <span>${bike.total_km.toFixed(1)} km</span>
              </div>
              <button class="edit-km-btn" onclick="showUpdateKmModal('${bike.id}')" title="Actualizar kilometraje">‚úèÔ∏è</button>
            </div>
            ${nextMaintenance ? `<div class="alert-badge ${alertClass}">${alertIcon} ${alertText}</div>` : ''}
            <div class="bike-stats">
              <div class="bike-stat-item">
                <div class="bike-stat-value">${maintenanceCount}</div>
                <div class="bike-stat-label">Mantenimientos</div>
              </div>
              <div class="bike-stat-item">
                <div class="bike-stat-value">${totalCost.toFixed(0)}${currencySymbol}</div>
                <div class="bike-stat-label">Coste Total</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderMaintenance() {
      const maintenanceList = document.getElementById('maintenance-list');
      let maintenance = allData.filter(d => d.type === 'maintenance');

      if (currentFilter) {
        maintenance = maintenance.filter(m => m.bike_id === currentFilter);
      }

      if (currentComponentFilter) {
        maintenance = maintenance.filter(m => m.component === currentComponentFilter);
      }

      if (currentSearch) {
        const searchLower = currentSearch.toLowerCase();
        maintenance = maintenance.filter(m => 
          m.bike_name.toLowerCase().includes(searchLower) ||
          m.component.toLowerCase().includes(searchLower) ||
          m.maintenance_type.toLowerCase().includes(searchLower) ||
          (m.notes && m.notes.toLowerCase().includes(searchLower))
        );
      }

      maintenance.sort((a, b) => {
        switch(currentSort) {
          case 'date-desc':
            return new Date(b.date) - new Date(a.date);
          case 'date-asc':
            return new Date(a.date) - new Date(b.date);
          case 'cost-desc':
            return (b.cost || 0) - (a.cost || 0);
          case 'cost-asc':
            return (a.cost || 0) - (b.cost || 0);
          case 'km-desc':
            return (b.km_at_maintenance || 0) - (a.km_at_maintenance || 0);
          case 'km-asc':
            return (a.km_at_maintenance || 0) - (b.km_at_maintenance || 0);
          default:
            return new Date(b.date) - new Date(a.date);
        }
      });

      if (maintenance.length === 0) {
        maintenanceList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üîß</div>
            <h3>No hay mantenimientos registrados</h3>
            <p>Registra el primer mantenimiento de tus bicicletas para hacer seguimiento profesional</p>
          </div>
        `;
        return;
      }

      const currencySymbol = defaultConfig.currency_symbol;

      maintenanceList.innerHTML = maintenance.map(m => {
        const date = new Date(m.date);
        const formattedDate = date.toLocaleDateString('es-ES', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });

        return `
          <div class="maintenance-item">
            <div class="maintenance-header">
              <div>
                <div class="maintenance-title">${m.maintenance_type}</div>
                <div class="maintenance-bike">üö¥ ${m.bike_name}</div>
              </div>
              <button class="delete-maintenance" onclick="deleteMaintenance('${m.id}')">Eliminar</button>
            </div>
            <div>
              <span class="maintenance-component">${m.component}</span>
              ${m.cost > 0 ? `<span class="maintenance-cost">${m.cost.toFixed(2)} ${currencySymbol}</span>` : ''}
            </div>
            <div class="maintenance-meta">
              <div class="meta-item">üìÖ ${formattedDate}</div>
              ${m.km_at_maintenance ? `<div class="meta-item">üìç ${m.km_at_maintenance.toFixed(1)} km</div>` : ''}
              ${m.next_maintenance_km ? `<div class="meta-item">üîî Pr√≥ximo en ${m.next_maintenance_km} km</div>` : ''}
            </div>
            ${m.notes ? `<div class="maintenance-notes">üí¨ ${m.notes}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    function renderStock() {
      const stockList = document.getElementById('stock-list');
      let stock = allData.filter(d => d.type === 'stock');

      if (currentStockCategoryFilter) {
        stock = stock.filter(s => s.stock_category === currentStockCategoryFilter);
      }

      if (currentStockStatusFilter) {
        stock = stock.filter(s => {
          if (currentStockStatusFilter === 'ok') return s.stock_quantity > s.stock_min_quantity;
          if (currentStockStatusFilter === 'low') return s.stock_quantity > 0 && s.stock_quantity <= s.stock_min_quantity;
          if (currentStockStatusFilter === 'out') return s.stock_quantity === 0;
          return true;
        });
      }

      if (currentStockSearch) {
        const searchLower = currentStockSearch.toLowerCase();
        stock = stock.filter(s => 
          s.stock_name.toLowerCase().includes(searchLower) ||
          s.stock_category.toLowerCase().includes(searchLower) ||
          (s.stock_brand && s.stock_brand.toLowerCase().includes(searchLower)) ||
          (s.stock_location && s.stock_location.toLowerCase().includes(searchLower))
        );
      }

      if (stock.length === 0) {
        stockList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì¶</div>
            <h3>No hay materiales en el inventario</h3>
            <p>A√±ade componentes y materiales para gestionar tu stock</p>
          </div>
        `;
        return;
      }

      const currencySymbol = defaultConfig.currency_symbol;

      stockList.innerHTML = stock.map(s => {
        const isLowStock = s.stock_quantity > 0 && s.stock_quantity <= s.stock_min_quantity;
        const isOutOfStock = s.stock_quantity === 0;
        
        let cardClass = 'stock-card';
        let quantityClass = 'stock-quantity-display';
        let alertHTML = '';
        
        if (isOutOfStock) {
          cardClass += ' out-of-stock';
          quantityClass += ' out';
          alertHTML = '<div class="stock-alert danger">üö® SIN STOCK - Reponer urgentemente</div>';
        } else if (isLowStock) {
          cardClass += ' low-stock';
          quantityClass += ' low';
          alertHTML = '<div class="stock-alert warning">‚ö†Ô∏è STOCK BAJO - Considerar reposici√≥n</div>';
        }

        const categoryIcons = {
          'Transmisi√≥n': '‚õìÔ∏è',
          'Frenos': 'üõë',
          'Ruedas': 'üõû',
          'Suspensi√≥n': 'üî©',
          'Cockpit': 'üéØ',
          'Sill√≠n': 'ü™ë',
          'Lubricantes': 'üíß',
          'Herramientas': 'üîß',
          'Accesorios': '‚ú®',
          'Otros': 'üì¶'
        };

        const icon = categoryIcons[s.stock_category] || 'üì¶';
        const totalValue = s.stock_quantity * s.stock_unit_price;

        return `
          <div class="${cardClass}">
            <div class="stock-header">
              <div>
                <div class="stock-icon">${icon}</div>
                <div class="stock-name">${s.stock_name}</div>
                <span class="stock-category">${s.stock_category}</span>
                ${s.stock_brand ? `<div class="stock-brand">Marca: ${s.stock_brand}</div>` : ''}
              </div>
              <button class="delete-stock" onclick="deleteStock('${s.id}')" title="Eliminar material">√ó</button>
            </div>
            <div class="${quantityClass}">
              <div>
                <div style="font-size: 12px; opacity: 0.9;">CANTIDAD</div>
                <div style="font-size: 24px;">${s.stock_quantity} uds</div>
              </div>
              <div class="quantity-controls">
                <button class="quantity-btn" onclick="updateStockQuantity('${s.id}', -1)" title="Reducir cantidad">‚àí</button>
                <button class="quantity-btn" onclick="updateStockQuantity('${s.id}', 1)" title="Aumentar cantidad">+</button>
              </div>
            </div>
            ${alertHTML}
            <div class="stock-details">
              <div class="stock-detail-item">
                <span class="stock-detail-label">Stock M√≠nimo:</span>
                <span class="stock-detail-value">${s.stock_min_quantity} uds</span>
              </div>
              ${s.stock_unit_price > 0 ? `
                <div class="stock-detail-item">
                  <span class="stock-detail-label">Precio Unitario:</span>
                  <span class="stock-detail-value">${s.stock_unit_price.toFixed(2)} ${currencySymbol}</span>
                </div>
                <div class="stock-detail-item">
                  <span class="stock-detail-label">Valor Total:</span>
                  <span class="stock-detail-value">${totalValue.toFixed(2)} ${currencySymbol}</span>
                </div>
              ` : ''}
              ${s.stock_location ? `
                <div class="stock-detail-item">
                  <span class="stock-detail-label">Ubicaci√≥n:</span>
                  <span class="stock-detail-value">${s.stock_location}</span>
                </div>
              ` : ''}
            </div>
            ${s.stock_notes ? `<div class="stock-notes-display">üí¨ ${s.stock_notes}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    function renderStats() {
      const bikes = allData.filter(d => d.type === 'bike');
      const maintenance = allData.filter(d => d.type === 'maintenance');
      const stock = allData.filter(d => d.type === 'stock');
      
      const totalKm = bikes.reduce((sum, b) => sum + (b.total_km || 0), 0);
      const totalCost = maintenance.reduce((sum, m) => sum + (m.cost || 0), 0);
      const avgCostPerBike = bikes.length > 0 ? totalCost / bikes.length : 0;
      const costPerKm = totalKm > 0 ? totalCost / totalKm : 0;
      const avgMaintenancePerBike = bikes.length > 0 ? maintenance.length / bikes.length : 0;
      
      const totalStockValue = stock.reduce((sum, s) => sum + (s.stock_quantity * s.stock_unit_price), 0);
      const lowStockItems = stock.filter(s => s.stock_quantity > 0 && s.stock_quantity <= s.stock_min_quantity).length;
      const outOfStockItems = stock.filter(s => s.stock_quantity === 0).length;
      
      const currencySymbol = defaultConfig.currency_symbol;

      document.getElementById('general-stats').innerHTML = `
        <div class="stat-card">
          <span class="stat-card-icon">üö¥</span>
          <div class="stat-value">${bikes.length}</div>
          <div class="stat-label">Bicicletas</div>
        </div>
        <div class="stat-card">
          <span class="stat-card-icon">üîß</span>
          <div class="stat-value">${maintenance.length}</div>
          <div class="stat-label">Mantenimientos</div>
          <div class="stat-sublabel">${avgMaintenancePerBike.toFixed(1)} por bici</div>
        </div>
        <div class="stat-card">
          <span class="stat-card-icon">üìç</span>
          <div class="stat-value">${totalKm.toFixed(0)}</div>
          <div class="stat-label">Km Totales</div>
        </div>
        <div class="stat-card">
          <span class="stat-card-icon">üí∞</span>
          <div class="stat-value">${totalCost.toFixed(0)}${currencySymbol}</div>
          <div class="stat-label">Coste Total</div>
          <div class="stat-sublabel">${costPerKm.toFixed(2)}${currencySymbol}/km</div>
        </div>
        <div class="stat-card">
          <span class="stat-card-icon">üì¶</span>
          <div class="stat-value">${stock.length}</div>
          <div class="stat-label">Materiales</div>
          <div class="stat-sublabel">${totalStockValue.toFixed(0)}${currencySymbol} en stock</div>
        </div>
        <div class="stat-card">
          <span class="stat-card-icon">‚ö†Ô∏è</span>
          <div class="stat-value">${lowStockItems + outOfStockItems}</div>
          <div class="stat-label">Alertas Stock</div>
          <div class="stat-sublabel">${outOfStockItems} sin stock</div>
        </div>
      `;

      renderTopComponents(maintenance);
      renderBikeDetails(bikes, maintenance, currencySymbol);
    }

    function renderTopComponents(maintenance) {
      const componentCounts = {};
      maintenance.forEach(m => {
        componentCounts[m.component] = (componentCounts[m.component] || 0) + 1;
      });

      const topComponents = Object.entries(componentCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      if (topComponents.length === 0) {
        document.getElementById('top-components-section').innerHTML = '';
        return;
      }

      const maxCount = topComponents[0][1];

      const topComponentsHTML = topComponents.map(([component, count], index) => {
        const percentage = (count / maxCount) * 100;
        let rankClass = '';
        if (index === 0) rankClass = 'gold';
        else if (index === 1) rankClass = 'silver';
        else if (index === 2) rankClass = 'bronze';

        return `
          <div class="top-component-item">
            <div class="rank-badge ${rankClass}">${index + 1}</div>
            <div style="flex: 1;">
              <div style="font-weight: 700; color: #2d3748; margin-bottom: 5px;">${component}</div>
              <div class="component-bar">
                <div class="component-bar-fill" style="width: ${percentage}%"></div>
              </div>
            </div>
            <div style="font-weight: 800; color: #667eea; font-size: 18px;">${count}</div>
          </div>
        `;
      }).join('');

      document.getElementById('top-components-section').innerHTML = `
        <div class="top-components">
          <h3>üèÜ Top 5 Componentes M√°s Cambiados</h3>
          ${topComponentsHTML}
        </div>
      `;
    }

    function renderBikeDetails(bikes, maintenance, currencySymbol) {
      const bikeDetailsSection = document.getElementById('bike-details-section');
      
      if (bikes.length === 0) {
        bikeDetailsSection.innerHTML = '';
        return;
      }

      bikeDetailsSection.innerHTML = bikes.map(bike => {
        const bikeMaintenance = maintenance.filter(m => m.bike_id === bike.id);
        const componentHistory = {};
        
        bikeMaintenance.forEach(m => {
          if (!componentHistory[m.component]) {
            componentHistory[m.component] = [];
          }
          componentHistory[m.component].push(m);
        });

        const componentList = Object.entries(componentHistory)
          .map(([component, records]) => {
            records.sort((a, b) => new Date(b.date) - new Date(a.date));
            const lastMaintenance = records[0];
            const count = records.length;
            const totalCostComponent = records.reduce((sum, r) => sum + (r.cost || 0), 0);
            
            return `
              <div class="component-item">
                <div>
                  <div class="component-name">${component}</div>
                  <div style="font-size: 12px; color: #718096; margin-top: 4px;">
                    ${count} cambio${count > 1 ? 's' : ''} ‚Ä¢ √öltimo: ${new Date(lastMaintenance.date).toLocaleDateString('es-ES')}
                  </div>
                </div>
                <div class="component-info">
                  ${lastMaintenance.km_at_maintenance ? `<span class="km-badge">${lastMaintenance.km_at_maintenance.toFixed(0)} km</span>` : ''}
                  ${totalCostComponent > 0 ? `<span>${totalCostComponent.toFixed(2)} ${currencySymbol}</span>` : ''}
                </div>
              </div>
            `;
          }).join('');

        return `
          <div class="component-history">
            <h3>üö¥ ${bike.bike_name} - Historial de Componentes</h3>
            <div class="component-list">
              ${componentList || '<p style="color: #718096; text-align: center;">No hay mantenimientos registrados para esta bicicleta</p>'}
            </div>
          </div>
        `;
      }).join('');
    }

    function updateBikeSelectors() {
      const bikes = allData.filter(d => d.type === 'bike');
      const maintenanceBikeSelect = document.getElementById('maintenance-bike');
      const filterBikeSelect = document.getElementById('filter-bike');

      const bikeOptions = bikes.map(bike => 
        `<option value="${bike.id}">${bike.bike_name} (${bike.total_km.toFixed(1)} km)</option>`
      ).join('');

      maintenanceBikeSelect.innerHTML = '<option value="">Selecciona una bicicleta</option>' + bikeOptions;
      filterBikeSelect.innerHTML = '<option value="">Todas</option>' + bikeOptions;
    }

    function updateComponentFilter() {
      const maintenance = allData.filter(d => d.type === 'maintenance');
      const components = [...new Set(maintenance.map(m => m.component))].sort();
      
      const filterComponentSelect = document.getElementById('filter-component');
      const componentOptions = components.map(comp => 
        `<option value="${comp}">${comp}</option>`
      ).join('');

      filterComponentSelect.innerHTML = '<option value="">Todos</option>' + componentOptions;
    }

    function updateStockCategoryFilter() {
      const stock = allData.filter(d => d.type === 'stock');
      const categories = [...new Set(stock.map(s => s.stock_category))].sort();
      
      const filterCategorySelect = document.getElementById('filter-stock-category');
      const categoryOptions = categories.map(cat => 
        `<option value="${cat}">${cat}</option>`
      ).join('');

      filterCategorySelect.innerHTML = '<option value="">Todas</option>' + categoryOptions;
    }

    let currentFilter = "";
    let currentComponentFilter = "";
    let currentSearch = "";
    let currentSort = "date-desc";
    let currentStockCategoryFilter = "";
    let currentStockStatusFilter = "";
    let currentStockSearch = "";


    function filterMaintenance() {
      currentFilter = document.getElementById('filter-bike').value;
      currentComponentFilter = document.getElementById('filter-component').value;
      currentSearch = document.getElementById('search-maintenance').value;
      currentSort = document.getElementById('sort-maintenance').value;
      renderMaintenance();
    }

    function filterStock() {
      currentStockCategoryFilter = document.getElementById('filter-stock-category').value;
      currentStockStatusFilter = document.getElementById('filter-stock-status').value;
      currentStockSearch = document.getElementById('search-stock').value;
      renderStock();
    }


    function showUpdateKmModal(bikeId) {
      const bike = allData.find(d => d.id === bikeId);
      if (!bike) return;

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      
      modal.innerHTML = `
        <div class="modal-content">
          <h3 style="margin: 0 0 20px 0; color: #2d3748; font-size: 22px; font-weight: 800;">
            üìç Actualizar Kilometraje
          </h3>
          <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <p style="margin: 0 0 5px 0; color: #718096; font-size: 13px; font-weight: 600;">BICICLETA</p>
            <p style="margin: 0; color: #2d3748; font-size: 16px; font-weight: 700;">${bike.bike_name}</p>
            <p style="margin: 10px 0 0 0; color: #4a5568; font-size: 14px;">
              <strong>Kilometraje actual:</strong> ${bike.total_km.toFixed(1)} km
            </p>
          </div>
          <div class="form-group">
            <label for="new-km">Nuevo Kilometraje Total</label>
            <input type="number" id="new-km" value="${bike.total_km}" min="${bike.total_km}" step="0.1" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px;">
          </div>
          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="updateBikeKm('${bikeId}')" class="btn-primary" style="flex: 1;">Actualizar</button>
            <button onclick="closeModal()" class="btn-secondary" style="flex: 1;">Cancelar</button>
          </div>
        </div>
      `;
      
      modal.onclick = (e) => {
        if (e.target === modal) closeModal();
      };
      
      document.body.appendChild(modal);
      window.currentModal = modal;
    }

    function closeModal() {
      if (window.currentModal) {
        window.currentModal.remove();
        window.currentModal = null;
      }
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    init();
  </script>
 </body>
</html>
