<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BikeMate V3: Control Profesional</title>
    <link rel="stylesheet" href="style.css"> 
    
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script> 
</head>
<body onload="initApp()">
    <header>
        <h1>üö¥ BikeMate V3: Control Total de Mantenimiento</h1>
        <button id="logout-button" style="display:none;" onclick="handleLogout()">Cerrar Sesi√≥n</button>
    </header>

    <main>
        <div id="auth-view" class="auth-container">
            <h2>Acceso a BikeMate</h2>
            <label for="auth-email">Email:</label>
            <input type="email" id="auth-email" placeholder="email@ejemplo.com">
            <label for="auth-password">Contrase√±a:</label>
            <input type="password" id="auth-password" placeholder="M√≠nimo 6 caracteres">
            
            <button style="background-color: var(--primary-color);" onclick="handleSignUp()">Registrarse</button>
            <button style="background-color: var(--secondary-color); margin-top: 10px;" onclick="handleLogin()">Iniciar Sesi√≥n</button>
            
            <p id="auth-message" style="color: var(--error-color); margin-top: 15px;"></p>
        </div>

        <div id="app-content" style="display:none;">
            <nav class="tabs-container">
                <button class="tab-button active" onclick="showSection('dashboard')">üõ†Ô∏è Panel de Taller</button>
                <button class="tab-button" onclick="showSection('maintenance')">üîß Mantenimiento/Reemplazo</button>
                <button class="tab-button" onclick="showSection('inventory')">üì¶ Inventario y Stock</button>
                <button class="tab-button" onclick="showSection('admin')">‚öôÔ∏è Admin</button>
                <button class="tab-button" onclick="showSection('logs')">üìú Log de Eventos</button>
            </nav>

            <div id="dashboard" class="tab-content active">
                <h2>Gesti√≥n de Reparaciones y Trazabilidad (CRM)</h2>
                <p class="description">Visualiza las bicicletas por el estado actual de su servicio. (Panel Kanban simple)</p>
                
                <section id="repair-panel-board">
                    <div id="panel-board-container" class="kanban-board">
                        Cargando trabajos...
                    </div>
                </section>
            </div>
            
            <div id="maintenance" class="tab-content">
                <section id="maintenance-form">
                    <h2>Registro de Reemplazo (Transacci√≥n At√≥mica)</h2>
                    <p class="description">Registra un cambio de componente, guarda el costo y resetea el contador de KM.</p>
                    
                    <label for="maint-bike-id">ID de Bicicleta:</label>
                    <input type="text" id="maint-bike-id" value="bike_prueba_123">

                    <label for="maint-comp-id">ID de Componente a Reemplazar:</label>
                    <input type="text" id="maint-comp-id" value="comp_cadena_456">

                    <label for="maint-date">Fecha de Servicio:</label>
                    <input type="date" id="maint-date" value="">

                    <label for="maint-cost">Costo del Componente (‚Ç¨):</label>
                    <input type="number" id="maint-cost" value="45.00">

                    <label for="maint-km-input">KM de la Bici en el Servicio:</label>
                    <input type="number" id="maint-km-input" value="1050">
                    
                    <button style="background-color: var(--primary-color);" onclick="handleReplacement()">Registrar Reemplazo y Resetear</button>
                </section>
            </div>

            <div id="inventory" class="tab-content">
                <section id="inventory-list-section">
                    <h2>Componentes en Stock</h2>
                    <div id="stock-list">Cargando inventario...</div>
                </section>
                
                <details class="new-item-details">
                    <summary>‚ûï A√±adir/Usar Stock</summary>
                    <div class="form-group">
                        <label for="stock-part-id">ID √önico del Recambio:</label>
                        <input type="text" id="stock-part-id" placeholder="Ej: pastillas_xtr">
                        <label for="stock-name">Nombre:</label>
                        <input type="text" id="stock-name" placeholder="Pastillas de Freno XTR">
                        <label for="stock-qty">Cantidad en Stock:</label>
                        <input type="number" id="stock-qty" value="1">
                        <label for="stock-compatibility">Bicicletas Compatibles (IDs separados por coma):</label>
                        <input type="text" id="stock-compatibility" placeholder="bmx_roja, bici_prueba_123">
                        
                        <button onclick="addOrUpdateStock()" style="background-color: var(--secondary-color); margin-bottom: 10px;">A√±adir/Actualizar Stock</button>
                        <button onclick="useStock('stock-part-id')" style="background-color: var(--error-color);">Usar una Unidad (-1)</button>
                    </div>
                </details>
            </div>

            <div id="admin" class="tab-content">
                <section id="admin-tools">
                    <h2>‚öôÔ∏è Herramientas de Administraci√≥n</h2>
                    <p class="description">Para crear datos iniciales y realizar tareas de diagn√≥stico.</p>
                    
                    <h3>A√±adir Nueva Bicicleta</h3>
                    <div class="form-group">
                        <label for="admin-new-bike-id">ID √önico:</label>
                        <input type="text" id="admin-new-bike-id" placeholder="ID de la bicicleta">
                        <label for="admin-new-bike-name">Nombre:</label>
                        <input type="text" id="admin-new-bike-name" placeholder="Ej: Bici de Monta√±a">
                        <label for="admin-new-bike-km">KM Inicial:</label>
                        <input type="number" id="admin-new-bike-km" value="0">
                        <button onclick="addBikeFromAdmin()" style="background-color: var(--secondary-color);">Guardar Nueva Bicicleta</button>
                    </div>

                    <h3>A√±adir Componente Inicial</h3>
                    <label for="admin-comp-bike-id">ID Bicicleta:</label>
                    <input type="text" id="admin-comp-bike-id" value="bike_prueba_123">
                    <label for="admin-comp-id">ID Componente:</label>
                    <input type="text" id="admin-comp-id" placeholder="Ej: cadena_km750">
                    <label for="admin-comp-max-km">Max KM Alerta:</label>
                    <input type="number" id="admin-comp-max-km" value="750">
                    <button onclick="addInitialComponent()" style="background-color: var(--warning-color);">Crear Componente Inicial</button>
                
                    <h3>Actualizaci√≥n de Kilometraje (Masiva)</h3>
                    <label for="admin-update-bike-id">ID de Bicicleta:</label>
                    <input type="text" id="admin-update-bike-id" value="bike_prueba_123">
                    <label for="admin-new-km-input">Nuevo KM Total:</label>
                    <input type="number" id="admin-new-km-input" value="1800">
                    <button style="background-color: var(--primary-color);" onclick="handleKmUpdateFromAdmin()">Actualizar KM y Recalcular</button>
                </section>
            </div>
            
            <div id="logs" class="tab-content">
                <section id="status-log">
                    <h2>üìú Log de Eventos y Errores</h2>
                    <div id="log-output">Esperando acciones...</div>
                </section>
            </div>
        </div>
    </main>

    <div id="bike-detail-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('bike-detail-modal')">&times;</span>
            <h2 id="detail-bike-name"></h2>
            <div class="detail-container">
                <nav class="detail-tabs-container">
                    <button class="detail-tab-button active" onclick="showDetailTab('components-view', this)">üõ†Ô∏è Componentes</button>
                    <button class="detail-tab-button" onclick="showDetailTab('history-view', this)">üìÖ Historial</button>
                    <button class="detail-tab-button" onclick="showDetailTab('notes-view', this)">üìù Notas/Engrase</button>
                </nav>

                <div id="components-view" class="detail-tab-content active">
                    <h3>Resumen de Componentes (√öltimo Cambio)</h3>
                    <div id="detail-components-list"></div>
                </div>

                <div id="history-view" class="detail-tab-content">
                    <h3>Historial de Mantenimiento Reciente</h3>
                    <div id="detail-history-list"></div>
                </div>

                <div id="notes-view" class="detail-tab-content">
                    <h3>Notas y Tareas Pendientes</h3>
                    <textarea id="detail-notes-input" placeholder="A√±ade aqu√≠ notas de engrase, ajustes de suspensi√≥n, o tareas pendientes..."></textarea>
                    <button onclick="saveBikeNotes()" style="background-color: var(--primary-color); margin-top: 15px;">Guardar Notas</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="app.js"></script> 
</body>
</html>